---
title: "Markdown II"
author: "<table style='table-layout:fixed;width:100%;border:0;padding:0;margin:0'><col width='10%'><col width='10%'>
  <tr style='border:none'>
    <td style='display:block;width:100%;text-align:left;vertical-align:bottom;padding:0;margin:0;border:none' nowrap>
      <font style='font-style:normal'>Reporting mit R</font><br>
      <a href='https://therbootcamp.github.io/SmR_2020Jun/'>
        <i class='fas fa-clock' style='font-size:.9em;' ></i>
      </a>
      <a href='https://therbootcamp.github.io'>
        <i class='fas fa-home' style='font-size:.9em;'></i>
      </a>
      <a href='mailto:therbootcamp@gmail.com'>
        <i class='fas fa-envelope' style='font-size: .9em;'></i>
      </a>
      <a href='https://www.linkedin.com/company/basel-r-bootcamp/'>
        <i class='fab fa-linkedin' style='font-size: .9em;'></i>
      </a>
      <a href='https://therbootcamp.github.io'>
        <font style='font-style:normal'>The R Bootcamp</font>
      </a>
    </td>
    <td style='width:100%;vertical-align:bottom;text-align:right;padding:0;margin:0;border:none'>
      <img src='https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/by-sa.png' style='height:15px;width:80px'/>
    </td>
  </tr></table>"
output:
  html_document:
    css: practical.css
    self_contained: no
---

<style>
pre code,  .md:not(.use-csslab) pre code {
  white-space: pre-wrap;
  }
</style>

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(comment = NA, 
                      fig.width = 6, 
                      fig.height = 6,
                      fig.align = 'center',
                      echo = FALSE, 
                      eval = FALSE, 
                      warning = FALSE)

options(digits = 3)

# Load packages
library(tidyverse)
library(lubridate)
library(knitr)
library(kableExtra)
library(sjPlot)
```

<p align="center" width="100%">
  <img src="image/flat_crop.png" alt="Chunks" style="width:100%">
  <br>
  <font style="font-size:10px">from <a href="https://www.airbnb.ca/rooms/1347514/photos/13227297?guests=4&s=4fFl&source_impression_id=p3_1591077094_V6VkyaMzWmptgznT&adults=1">airbnb.ca</a></font>
</p>
 

# {.tabset}

## Überblick

Aufbauend auf Practical 1 wirst du nun die Grafiken in deinem Dokument gestalten 
und weitere Textbausteine einfügen.

1. Grafiken formatieren.
3. Datentabellen einfügen und im Detail gestalten
4. Ergebnisse eines Regressionsmodells einbinden.

## Aufgaben

### A - Setup

1. Öffne dein `TheRBootcamp` R Projekt. Es sollte die Ordner `1_Data`, `2_Assets`, und `3_Markdown` enthalten. 

2. Lade die `airbnb_level_one.Rmd` Datei, das fertige Produkt am Ende des ersten Markdown Practicals. 

3. Zusätzlich lade die Pakete `knitr`, `kableExtra` `sjPlot` im `setup` chunk. 

### B - Präambel: Fussnote einfügen

1. Ergänze eine Fussnote nach dem Texteil 'verfügbarer Daten' `^[Daten wurde heruntergeladen von [insideairbnb.com](http://insideairbnb.com/get-the-data.html)]`

2. `Knitte` das Dokument. Sieht alles in Ordnung aus?  

### C - Neueinstellungen: Plots

Für beide Grafiken wirst du nun die Darstellung verbessern und Captions einfügen

1. Setze die aspect ratio der ersten Grafik auf .5 (`fig.asp = .5`).

2. Füge `fig.cap = cap` im Chunk der ersten Grafik ein.

3. Am Ende des Grafik Chunks definiere den Text der Caption: `cap = Abbildung 1. Neueinstellungen pro Monat.`

4. Setze nun die aspect ratio für die zweite Grafik auf .5.

5. Am Ende des zweiten Grafik Chunks `cap = Abbildung 2. Neueinstellungen pro Bezirk.` einfügen.

6. `Knitte` das Dokument. Sieht alles in Ordnung aus?  

### D - Preise: Neuer Texteil

1. Für einen neuen Abschnitt füge `Preis` als Level 3 Header ein.

2. Nun den folgenden Text integrieren.

````wrap
Der durchschnittliche Preis der Neueinstellungen beträgt 80.8 €. Im Vergleich zum Vorjahr sind die Preise der Neueinstellungen um 1.7% gestiegen.
````

3. In diesem Text werden die Zahlen nicht berechnet - füge inline Code für den durschschnittlichen Preis aus dem Datensatz `airbnb_1819` direkt im Text ein.

```{r echo = TRUE}
round(mean(airbnb_1819 %>% pull(Preis)),1)
```

4. Wähle die gleiche Vorgangsweise für die prozentuelle Steigerung der Preise verwende folgenden Code für die Berechnung.

```{r echo = TRUE}
m <- mean(airbnb_1819 %>% 
          filter(year(Erstellungsdatum) == 2019) %>% 
          pull(Preis))/mean(airbnb_1819 %>% 
          filter(year(Erstellungsdatum) == 2018) %>% 
          pull(Preis))
round(m, 3) * 100 - 100
```

5. `Knitte` das Dokument. Sieht alles in Ordnung aus?  

### E - Preise: Neuer Texteil

1. Erstelle ein neues Unterkapitel mit der Überschrift: `Einfluss Ausstattsung` (als Level 4 Header).

2. Berechne als erster Schritt in einem eigenem Code Chunk wie sich die verschiednen Ausstattungsmerkmale (Küche, Wifi, ...) auf die durchschnittlichen Preise auswirken. Diesen Chunk nicht ausgeben!

```R
# Vektor mit Ausstatttungsmerkmalen
ausstattung_var = c('Küche','Wifi','TV','Kaffeemaschine',
                    'Geschirrspüler','Terrasse_Balkon',
                    'Check_in_24h')

# Bestimme Preise als Funktion der Ausstatttungsmerkmale
ausstattung <- airbnb_1819 %>% 
               select(all_of(ausstattung_var), Preis) %>%
               pivot_longer(-Preis,
               names_to = 'Ausstattung',
               values_to = 'Ausstattung_vorhanden') %>% 
              group_by(Ausstattung) %>% 
  summarize(Nicht_vorhanden = mean(Preis[!Ausstattung_vorhanden]),
            Vorhanden = mean(Preis[Ausstattung_vorhanden]),
            Differenz = Vorhanden - Nicht_vorhanden, 
            Prozent_vorhanden = mean(Ausstattung_vorhanden) * 100) %>% 
  arrange(desc(Differenz)) 
```

3. Füge einen neuen Textteil ein

````wrap
Das Austattungsmerkmal mit dem grössten Unterschied im Preis ist Check_in_24h (72.9), das Austattungsmerkmal mit dem kleinsten Unterschied im Preis ist Küche (-88.9).
````

4. Auch hier wieder den Variablenamen und den numerischen Wert in Klammer (grösster Unterschied im Preis) mit folgendem inline code berechnen und einsetzen.
```{r echo = TRUE}
ausstattung %>% pull(Ausstattung) %>% first()
ausstattung %>% pull(Differenz) %>% first() %>% round(1)
```

5. Variablename und numerischen Wert in Klammer (kleinster Unterschied im Preis) berechnen und einsetzen.
```{r echo = TRUE}
ausstattung %>% pull(Ausstattung) %>% last()
ausstattung %>% pull(Differenz) %>% last() %>% round(1)
```

6. Der folgenden Textabschnitt fasst die Ergebnisse der Tabelle zusammen und soll daher hervorgehoben werden. Kennzeichne den Textabschnitt mit dem HTML Tag `<b> ... </b>` und setze ihn damit in fetter Schriftart.

````wrap
Der stark negative Effekt der Küche überrascht, er könnte jedoch durch die Art der Unterkunft moderiert werden, gegeben dass auch Hotels im Angebot enthalten sind.
````

7. `Knitte` das Dokument. Sieht alles in Ordnung aus?  

### F - Preis: Tabelle 1 erzeugen

1. Neuen Code Chunk mit der Tabelle Ausstattung und `kable()` erstellen.

```R
# Plotte Tabelle mit Austattungsmerkmalen
ausstattung %>% kable(format = 'html')
```

2. Anzahl Nachkommastellen mit `digits = 2` auf zwei beschränken.

3. Caption mit `caption = 'Tabelle 1. Austtatung und Einfluss auf den Preis'` einfügen.

4. Die Namen der Spalten anpassen: `col.names = c('', 'Preis<br>Nicht-vorh.', 'Preis<br>vorh.','Differenz','Prozent<br>vorh.')`

5. Spezielle Schriftzeichen direkt einfügen `escape = FALSE` 

6. Das Alginment der Zellen festlegen mit `align="lcccc"`

7. Die Breite der Spalten fixieren mit `column_spec(c(2,3,4,5), width = "1.2in")`

8. Die Schrifgrösse der Zellen in Abhängigkeit ihrer Grösse verändern. Dafür vor 
dem `kable` Abschnitt folgenden Code einfügen und mit einer Pipe (%>%) verbinden.

```R
mutate_if(is.numeric, function(x) {
    cell_spec(round(x,1), bold = T, 
              font_size = spec_font_size(x, begin=10, end=16))})
```

9. `Knitte` das Dokument. Sieht alles in Ordnung aus?  

### G - Preise: Text Teil

1. `Regressionsmodell` als Level 4 Header einfügen

2. In einem eigenem Code Chunk eine Regression berechnen in der `Preis` mit verschiednen Ausstattungsmerkmalen vorhergesagt wird sowie mittleren Anteil der Hotels berechnen. Diesen Chunk nicht augeben!

```R
# Reduzierter Vektor mit Ausstattungsmerkmalen
ausstattung_var <- c('Küche','TV','Terrasse_Balkon','Check_in_24h')

# Rechne Regression des Preises auf Austattungsmerkmale und Hotel
ausstattung_mod <- airbnb_1819 %>% 
  mutate(Hotel = Unterkunftsart %in% c('Boutique hotel', 'Hotel')) %>% 
  select(Preis, Hotel, all_of(ausstattung_var)) %>% 
  lm(formula = Preis ~ .)
  
# Bestimme Anteil Hotels in 2018 und 2019
hotel <- airbnb_1819 %>% 
  group_by(year(Erstellungsdatum)) %>% 
  summarize(Anteil = mean(Unterkunftsart %in% c('Boutique hotel', 'Hotel')))   
```

3. Folgenden Textblock einfügen

`````wrap
Die Regression legt nahe, dass Küche, TV und Terrasse oder Balkon den grössten Einfluss auf den Preis in denletztene beiden Jahren hatten.

Der Einfluss der Küche ist gegenüber dem Unterschied in Tabelle 1 gesunken, jedoch nach wie vor signifikant.

Überraschenderweise ist der Effekt eines 24h Check-ins, welcher deskriptiv am grössten ausfiel, nicht signifikant. Dies ist ebenfalls auf den Zusammen zur Unterkunftsart zurückzuführen

Es besteht ein substantieller Unterschied im Preis zwischen Unterkunftsarten. Hotels haben eine um 437.3€ höheren Preis als Unterkünfte die keine Hotels sind.

Der Anteil von Hotels ist von -98.9% im Jahre 2018 auf 1.4% im Jahre 2019 gestiegen. Es liegt nahe, dass der Anstieg im Anteil der Hotels, den Anstieg der Objektpreise verursacht.
`````

4. Den Koeffizienten aus dem Regressionsmodell im 4. Absatz (Hotels haben einen um ... höheren Preis) mit folgendem inline code berechnen und einsetzen.

```{r echo = TRUE}
coefficients(ausstattung_mod)['HotelTRUE'] %>% round(1)
```

5. Mittels HTML Tag `<b>` den 2. (`Überraschenderweise ...`) und 4. Absatz (`Der Anteil ...`) fett hervorheben.

6. `Knitte` das Dokument. Sieht alles in Ordnung aus?  

### H - Preise: Regressionstabelle

1. Die Regressionsergebnisse mit `sjPlot::tab_model` ausgeben

```R
# Tabelle mit ergebnissen der Regression
tab_model(ausstattung_mod)
```

2. Intercept mit `Achsenabschnitt` in der Tabelle ersetzen `pred.labels = c('Achsenabschnitt', names(ausstattung)[-1])`

3. Tabellentitel einfügen: `title = 'Table 2. Regression des Preises auf die Ausstattung.'`

4. `Knitte` das Dokument. Sieht alles in Ordnung aus?  


## Datensatz

Der [airbnb.csv](https://raw.githubusercontent.com/therbootcamp/RmR_2020Apr/master/_materials/case/airbnb.csv) Datensatz enthält Zahlen zu 9868 Berliner Airbnbs 


|Variable | Beschreibung |
|:-------------|:-------------------------------------|
|Preis| Preis pro Nacht|
 |Erstellungsdatum| Eröffnungsdatum des Airbnbs |
 |Unterkunftsart| Appartement, Loft, House, etc.|
 |Schlafplätze| Anzahl Schlafplätze |
 |Schlafzimmer| Anzahl Schlafzimmer |
 |Badezimmer| Anzahl Badezimmer |
 |Reinigungsgebühr| Reinigungsgebühr |
 |Verfügbarkeit_90Tage| |
 |Viertel| In welchem Viertel befindet sich das Airbnb |
 |Stadtteil| In welchem Stadtteil befindet sich das Airbnb |
 |Breitengrad| Breitengrad|
 |Längengrad| Längengrad |
 |Host_id| Host id |
 |Host_seit| Erfahrung des Hosts |
 |Host_antwortzeit| Host Antwortzeit|
 |Host_antwortrate| Host Antwortrate |
 |Host_superhost| Superhost Ja/Nein |
 |Host_anzahl| Anzahl Gäste |
 |Rating_gesamt| Gesamtrating |
 |Rating_genauigkeit| Genauigkeitsrating |
 |Rating_sauberkeit| Sauberkeitsrating |
 |Rating_checkin| Checkinrating |
 |Rating_kommunikation| Kommunikationsrating |
 |Rating_lage| Lagerating |
 |Rating_wertigkeit| Wertigkeitsrating |
 |Küche| Küche vorhanden TRUE/FALSE |
 |Wifi| WLAN vorhanden TRUE/FALSE |
 |TV| TV vorhanden TRUE/FALSE |
 |Kaffeemaschine| Kaffeemaschine vorhanden TRUE/FALSE|
 |Geschirrspüler| Geschirrspüler vorhanden TRUE/FALSE|
 |Terrasse_Balkon| Terrasse/Balkon vorhanden TRUE/FALSE|
 |Badewanne| Badewanne vorhanden TRUE/FALSE|
 |Check_in_24h| 24h Check-In vorhanden TRUE/FALSE|



## Funktionen

### Paket

|Paket| Installation|
|:------|:------|
|`tidyverse`|`install.packages("tidyverse")`|
|`lubridate`|`install.packages("tidyverse")`|
|`knitr`|`install.packages("knitr")`|
|`sjPlot`|`install.packages("sjPlot")`|
|`kabelExtra`|`install.packages("kableExtra")`|

### Funktionen


| Funktion| Paket | Beschreibung |
|:---|:------|:---------------------------------------------|
| ``|``|  | 



## Materialien

- ...
- ...

