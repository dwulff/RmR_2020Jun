---
output:
  html_document:
    theme: lumen
    toc: true
    toc_depth: 5
    css: 2_Assets/airbnb.css
    includes:
      in_header: 2_Assets/header.Rhtml
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(knitr)
library(lubridate)
library(kableExtra)

airbnb_1819 <- read_csv('1_Data/airbnb.csv') %>% 
  filter(Erstellungsdatum > "2018-01-01", 
         Erstellungsdatum < "2019-12-31")
  
berlin <- readRDS('1_Data/berlin.RDS')

theme_set(theme_minimal())
ggplot <- function(...) ggplot2::ggplot(...) + 
  scale_fill_gradientn(colors = c('#555555','#6BB7B9')) + 
  scale_colour_gradientn(colors = c('#555555','#6BB7B9'))

cols = "https://www.colourlovers.com/palette/3498539/airbnb"

```

<!--## {.tabset}--->

### Neueinstellungen

#### Entwicklung

<table>
<col width = 40%>
<col width = 10%>
<col width = 50%>
<tr>
  <td>
  
Seit `r strftime(min(airbnb_1819$Erstellungsdatum), "%d.%m.%Y")` wurden in Berlin `r nrow(airbnb_1819)` Airbnb Wohnungen eingestellt. Von diesen Wohnungn weisen aktuell `r round(mean(airbnb_1819$Verfügbarkeit_90Tage > 0) * 100)`% Verfügbarkeiten von durchschnittlich `r round(mean(airbnb_1819$Verfügbarkeit_90Tage[airbnb_1819$Verfügbarkeit_90Tage>0]),1)` Tagen für die nächsten 3 Monate auf.

**Einstellungen von AirBnB Wohnungen haben im letzten Jahr stark zugenommen. Im Jahr 2019 wurden insgesamt `r n_2019 = sum(year(airbnb_1819$Erstellungsdatum) == 2019); n_2019` neue Wohnungen eingestellt wohingegend im Jahr 2018 nur `r n_2018 = sum(year(airbnb_1819$Erstellungsdatum) == 2018); n_2018` Wohnungen eingestellt wurden. Dies entspricht einem Zuwachs von `r (round(n_2019/n_2018, 2) - 1)*100`%.**
  </td>
  <td>
  </td>
  <td>

```{r message = F, echo = F, fig.asp=.5, fig.cap=cap}
ggplot(airbnb_1819 %>% 
         group_by(Jahr = year(Erstellungsdatum), month = month(Erstellungsdatum)) %>% 
         summarize(
           Monat = forcats::as_factor(paste(first(Jahr), first(month), sep = '-')),
           Wohnungen = n()), 
       aes(x = Monat, y = Wohnungen, fill = Jahr)) + 
  geom_bar(stat='identity', position='dodge') + 
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) 

cap = "<center>Figure 1. Neueinstellungen pro Monat</center>"

```
</td>
</tr>
</table>

#### Stadteile

<table>
<col width = 40%>
<col width = 10%>
<col width = 50%>
<tr>
  <td>

```{r, echo = FALSE}
Stadtteile <- airbnb_1819 %>% 
         group_by(Stadtteil, 
                  Jahr = year(Erstellungsdatum)) %>% 
         summarize(Wohnungen = n()) %>% 
  ungroup() %>% 
  arrange(desc(Jahr), Wohnungen) %>% 
  mutate(Stadtteil = as_factor(Stadtteil))



```

Neueinstellungen fallen nach wie vor sehr unterschiedlich in den Bezirke aus. Die meisten Neueinstellungen im Jahr 2019 gab es in `r Stadtteile %>% filter(Jahr == 2019) %>% pull(Stadtteil) %>% last()`, die wenigsten in `r Stadtteile %>% filter(Jahr == 2019) %>% pull(Stadtteil) %>% first()`.   
 
```{r, echo = FALSE}
Zuwachs = Stadtteile %>% 
  group_by(Stadtteil) %>% 
  summarize(Zuwachs = 100 * round(Wohnungen[Jahr == 2019]/Wohnungen[Jahr == 2018]-1,2))

min_stadtteil = Zuwachs %>% 
  slice(which.min(Zuwachs)) %>% 
  pull(Stadtteil)

max_stadtteil = Zuwachs %>% 
  slice(which.min(Zuwachs)) %>% 
  pull(Stadtteil)

min_veränderung = Zuwachs %>% 
  slice(which.min(Zuwachs)) %>% 
  pull(Zuwachs)

max_veränderung = Zuwachs %>% 
  slice(which.min(Zuwachs)) %>% 
  pull(Zuwachs)

```

**Die grössten Veränderungen gab es in `r min_stadtteil` und `r max_stadtteil`. In `r min_stadtteil` `r ifelse(min_veränderung > 0, "wuchsen", "schrumpften")` die Neueinstellungen um `r min_veränderung`%, in `r max_stadtteil` `r ifelse(max_veränderung > 0, "wuchsen", "schrumpften")` die Neueinstellungen um `r max_veränderung`%.**


</td>
<td>
</td>
<td>
```{r stadtteile, message = F, echo = F, fig.asp=.5, fig.cap = cap}

ggplot(Stadtteile, 
       aes(y = Stadtteil, x = Wohnungen, group = Jahr, fill = Jahr)) + 
  geom_bar(stat='identity', position='dodge') + 
  theme(legend.position = 'none') + labs(y='')

cap = "<center>Figure 2. Neueinstellungen pro Bezirk</center>"
```



</td>
</tr>
</table>

### Preis

#### Der Einfluss der Austattung

<table>
<col width = 40%>
<col width = 10%>
<col width = 50%>
<tr>
  <td>
  </td>
  <td>
  </td>
  <td>


```{r message = F, echo = F, fig.asp=.5}

austattung_var = c('Küche','Wifi','TV','Kaffeemaschine','Geschirrspüler','Terrasse_Balkon','Check_in_24h')
airbnb_1819 %>% 
  select(all_of(austattung_var), Preis) %>%
  pivot_longer(-Preis,
             names_to = 'Austattung',
             values_to = 'Vorhanden') %>% 
  group_by(Austattung) %>% 
  summarize(Prozent = mean(Vorhanden) * 100,
            Nicht_vorhanden = mean(Preis[!Vorhanden]),
            Vorhanden = mean(Preis[Vorhanden])) %>% 
  arrange(desc(Prozent)) %>% 
  mutate_if(is.numeric, function(x) {
    cell_spec(round(x,1), bold = T, 
              font_size = spec_font_size(x, begin=10, end=16))}) %>%
  kable(digits = 2,
        format='html', 
        caption = 'Tabelle 1. Austtatung und Einfluss auf den Preis', 
        col.names = c('', 'Prozent', 'Preis<br>Nicht-vorhanden', 'Preis<br>Vorhanden'),
        escape = FALSE,
        align="lccc") %>% 
  column_spec(c(2,3,4), width = "1.2in")

```

</td>
</tr>
</table>

#### Regressionsmodell

<table width=100%>
<col width = 40%>
<col width = 10%>
<col width = 50%>
<tr>
  <td>
  </td>
  <td>
  </td>
  <td style="float:right">

```{r message = F, echo = F, fig.asp=.5}

austattung_var <- c('Küche','Wifi','TV','Kaffeemaschine','Geschirrspüler','Terrasse_Balkon','Check_in_24h')
austattung <- airbnb_1819 %>% 
  select(Preis, all_of(austattung_var))

mod <- lm(Preis ~ ., data = austattung)
tab <- sjPlot::tab_model(mod, 
                  pred.labels = names(austattung),
                  title = 'Table 2. Regression des Preises auf die Austattung.',
                  CSS = list(css.caption = "font-weight:500", css.table="width: auto; margin-right: 0px;margin-left: auto;"))
tab
```

</td>
</tr>
</table>
